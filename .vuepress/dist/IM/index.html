<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>健康商城客服咨询 | 健康160前端分享1</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/frontend/assets/css/styles.51b8b1a7.css" as="style"><link rel="preload" href="/frontend/assets/js/app.51b8b1a7.js" as="script"><link rel="preload" href="/frontend/assets/js/7.d33824cd.js" as="script"><link rel="prefetch" href="/frontend/assets/css/2.styles.083de942.css"><link rel="prefetch" href="/frontend/assets/css/4.styles.5ce1cb36.css"><link rel="prefetch" href="/frontend/assets/js/1.5650c4c0.js"><link rel="prefetch" href="/frontend/assets/js/10.1f8f8057.js"><link rel="prefetch" href="/frontend/assets/js/11.6b812224.js"><link rel="prefetch" href="/frontend/assets/js/2.083de942.js"><link rel="prefetch" href="/frontend/assets/js/3.ca56cc0b.js"><link rel="prefetch" href="/frontend/assets/js/4.5ce1cb36.js"><link rel="prefetch" href="/frontend/assets/js/5.c070d30d.js"><link rel="prefetch" href="/frontend/assets/js/6.212aefff.js"><link rel="prefetch" href="/frontend/assets/js/8.264e1fee.js"><link rel="prefetch" href="/frontend/assets/js/9.2c0395b9.js">
    <link rel="stylesheet" href="/frontend/assets/css/2.styles.083de942.css"><link rel="stylesheet" href="/frontend/assets/css/4.styles.5ce1cb36.css"><link rel="stylesheet" href="/frontend/assets/css/styles.51b8b1a7.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/frontend/" class="home-link router-link-active"><!----> <span class="site-name">健康160前端分享1</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/frontend/" class="nav-link">Home</a></div><div class="nav-item"><a href="/frontend/guide/" class="nav-link">Guide</a></div><div class="nav-item"><a href="https://google.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  External
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/frontend/" class="nav-link">Home</a></div><div class="nav-item"><a href="/frontend/guide/" class="nav-link">Guide</a></div><div class="nav-item"><a href="https://google.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  External
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first collapsable"><p class="sidebar-heading"><span>移动端远程调试</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>原生JS</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>面向对象</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>智能页面</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading open"><span>IM即时通讯</span> <span class="arrow down"></span></p> <ul class="sidebar-group-items"><li><a href="/frontend/IM/" class="active sidebar-link">健康商城客服咨询</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/frontend/IM/#技术栈" class="sidebar-link">技术栈</a></li><li class="sidebar-sub-header"><a href="/frontend/IM/#websocket链接的创建" class="sidebar-link">websocket链接的创建</a></li><li class="sidebar-sub-header"><a href="/frontend/IM/#im消息体组装" class="sidebar-link">IM消息体组装</a></li><li class="sidebar-sub-header"><a href="/frontend/IM/#如何转换成二进制" class="sidebar-link">如何转换成二进制</a></li><li class="sidebar-sub-header"><a href="/frontend/IM/#im消息发送" class="sidebar-link">IM消息发送</a></li><li class="sidebar-sub-header"><a href="/frontend/IM/#im消息接收" class="sidebar-link">IM消息接收</a></li><li class="sidebar-sub-header"><a href="/frontend/IM/#websocket连接重新连接" class="sidebar-link">websocket连接重新连接</a></li></ul></li></ul></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>wechat-vue</span> <span class="arrow right"></span></p> <!----></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="健康商城客服咨询"><a href="#健康商城客服咨询" aria-hidden="true" class="header-anchor">#</a> 健康商城客服咨询</h1> <h2 id="技术栈"><a href="#技术栈" aria-hidden="true" class="header-anchor">#</a> 技术栈</h2> <p>vue + websocket(paho.mqtt) + protobuf</p> <ul><li>vue MVVM框架,数据绑定</li> <li>websocket 利用paho.mqtt框架创建websocket链接 <a href="https://www.eclipse.org/paho/files/jsdoc/Paho.MQTT.Client.html" target="_blank" rel="noopener noreferrer">文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li>protobuf 实现字符串跟二进制之间的相互转换</li></ul> <p>友情提示: IM最难的并不是websocket,而是交互</p> <h2 id="websocket链接的创建"><a href="#websocket链接的创建" aria-hidden="true" class="header-anchor">#</a> websocket链接的创建</h2> <div class="language- extra-class"><pre class="language-text"><code>initWebsocket(){
    var that = this;
    var options = { // websocket 连接的配置
        useSSL:true, // 开启安全传输 wss
        userName:this.user.user_id, // 用户名,通过接口获取
        password:this.user.access_token, // 密码,通过接口获取
        keepAliveInterval:10, // 发送心跳的时间,单位s, 不设置长时间不发消息websocket会自动断开
        timeout: 10, // 发送消息超时的时间
        onSuccess: function () { // websocket链接成功的回调
        }
        onFailure: function (message) { // websocket链接失败的回调
            console.log(&quot;Connection failed: &quot; + message.errorMessage);
        }
    };
    this.clientSocket = new PahoMQTT.Client('wss://msgwss.91160.com/mqtt', this.client_id);  // 通过域名连接
    // this.clientSocket = new PahoMQTT.Client('10.1.95.159',8090, this.client_id); // 通过ip跟端口连接
    this.clientSocket.connect(options);
}
</code></pre></div><h2 id="im消息体组装"><a href="#im消息体组装" aria-hidden="true" class="header-anchor">#</a> IM消息体组装</h2> <ol><li>IM消息体格式参考链接 <a href="http://confluence.rd.91160.com/pages/viewpage.action?pageId=12988649" target="_blank" rel="noopener noreferrer">confluence<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li>实际应用</li></ol> <div class="language- extra-class"><pre class="language-text"><code>var obj = {
    content:JSON.stringify({
        type: 1, // 1.普通消息2.图片, 其他值参考confluence
        business_id:this.orderNo,
        business_type:20,
        receiver_type:1, //2代表医生,1代表患者,3//平台客服/4:商家客服
        networkProvider:'webIm',
        networkType:'-2'
    }),
    send_time: + new Date(),
    sender_uid:this.user.user_id.toString(), // 发送者的user_id
    receiver_uid:this.customer_id.toString(), // 接收者的user_id
    member_id:0, // 家庭成员id,健康商城客服聊天固定是0,随访的时候选择对应的家庭成员
    message_id:getUuid(), // uuid,随机不重复的字符串
    guid:'',
    session_id:this.session_id, // 由sender_uid和receiver_uid组成,值小的在前,大的在后, ${receiver_uid}_${sender_uid}
    business_type:20 // 具体指参考confluence
}
</code></pre></div><h2 id="如何转换成二进制"><a href="#如何转换成二进制" aria-hidden="true" class="header-anchor">#</a> 如何转换成二进制</h2> <ol><li>方法一(运用于wechat-vue仓库)</li></ol> <div class="language- extra-class"><pre class="language-text"><code># MessageFormat_pb.js 是由c++程序protoc将IM.proto(文件路径'./IM.proto')文件转换成的,
# 具体命令 protoc --js_out=import_style=commonjs,binary:. IM.proto
import Message_pb from '../../../plugins/protobuf/MessageFormat_pb.js'
this.message = new Message_pb.Message();  
serializeBinary(obj){//将内容序列化成protobuf格式
    this.message.setContent(obj.content);
    this.message.setSendTime(obj.send_time);
    this.message.setReceiverUid(obj.receiver_uid);
    this.message.setMemberId(obj.member_id);
    this.message.setMessageId(obj.message_id);
    this.message.setGuid(obj.guid);
    this.message.setSenderUid(obj.sender_uid);
    this.message.setSessionId(obj.session_id);
    this.message.setBusinessType(obj.business_type);
    return this.message.serializeBinary();
}
var buffer = serializeBinary(obj)
</code></pre></div><ol start="2"><li>方法二(运用于91160-com仓库)推荐</li></ol> <div class="language- extra-class"><pre class="language-text"><code>// protobuf 为外部应用的js库
protobuf.load(&quot;/im/js/IM.proto&quot;, function(err, root) {
    if (err) {
        reject(err)
    }else {
        that.Message = root.lookupType(&quot;IMpackage.Message&quot;);
        resolve()
    }
});
var buffer = that.Message.encode(obj).finish();
</code></pre></div><h2 id="im消息发送"><a href="#im消息发送" aria-hidden="true" class="header-anchor">#</a> IM消息发送</h2> <ol><li>发送</li></ol> <div class="language- extra-class"><pre class="language-text"><code>// client.send(topic,payload,qos);
this.clientSocket.send('PTP',buffer,2);
// PTP 后端定制的主题
// buffer obj转换成的buffer
// qos: 0 Best effort (default). 1 At least once. 2 Exactly once.
</code></pre></div><ol><li>如何知道成功发送</li></ol> <div class="language- extra-class"><pre class="language-text"><code>// java收到消息之后会自动发送一个确认的消息,客户端的websocket会触发onMessageDelivered
this.clientSocket.onMessageDelivered = function(message){ // 消息送达的回调
    console.log('message Delivered');
    console.log(message) // message为自己最开始send的内容
    var msg = that.message.toObject(message.payloadBytes) //  that.message.toObject方法会将二进制转换成对象
    
};
</code></pre></div><h2 id="im消息接收"><a href="#im消息接收" aria-hidden="true" class="header-anchor">#</a> IM消息接收</h2> <ol><li>接受消息</li></ol> <div class="language- extra-class"><pre class="language-text"><code>// websocket监听onMessageArrived时间,当别的人发送消息给自己是会触发onMessageArrived
this.clientSocket.onMessageArrived = function (message) { // broker消息送达
} 
</code></pre></div><ol start="2"><li>接受的消息是二进制,需要解码
方法一 (wechat-vue)</li></ol> <div class="language- extra-class"><pre class="language-text"><code>var array = that.message.deserializeBinary(message.payloadBytes).array,
obj = {};
obj.content = JSON.parse( array[0] );
obj.send_time = array[1];
obj.receiver_uid = array[2];
obj.sender_uid = array[3];
obj.member_id = array[4];
obj.message_id = array[5];
obj.guid = array[6];
obj.session_id = array[7];
obj.business_type = array[8];
obj.is_read = 0;
console.log(obj)

</code></pre></div><p>方法二(91160-com)推荐</p> <div class="language- extra-class"><pre class="language-text"><code>protobuf.load(&quot;/im/js/IM.proto&quot;, function(err, root) {
    if (err) {
        reject(err)
    }else {
        that.Message = root.lookupType(&quot;IMpackage.Message&quot;);
        resolve()
    }
});
var message = that.Message.decode(message.payloadBytes);
</code></pre></div><h2 id="websocket连接重新连接"><a href="#websocket连接重新连接" aria-hidden="true" class="header-anchor">#</a> websocket连接重新连接</h2> <div class="language- extra-class"><pre class="language-text"><code>// websocket 连接断开,会触发onConnectionLost回调
 this.clientSocket.onConnectionLost = function (responseObject) {//websocket断开重新连接
    var options = { // 配置参考上面连接的时候
    };
    that.clientSocket.connect(options);
};
</code></pre></div></div> <div class="page-edit"><!----> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/frontend/diycms/main.html" class="prev">
          开发流程
        </a></span> <span class="next"><a href="/frontend/wechat-vue/">
          微信端前后端分离项目
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/frontend/assets/js/7.d33824cd.js" defer></script><script src="/frontend/assets/js/app.51b8b1a7.js" defer></script>
  </body>
</html>
