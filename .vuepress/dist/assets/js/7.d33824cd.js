(window.webpackJsonp=window.webpackJsonp||[]).push([[7],{162:function(e,t,s){"use strict";s.r(t);var n=s(0),a=Object(n.a)({},function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("div",{staticClass:"content"},[e._m(0),e._v(" "),e._m(1),e._v(" "),s("p",[e._v("vue + websocket(paho.mqtt) + protobuf")]),e._v(" "),s("ul",[s("li",[e._v("vue MVVM框架,数据绑定")]),e._v(" "),s("li",[e._v("websocket 利用paho.mqtt框架创建websocket链接 "),s("a",{attrs:{href:"https://www.eclipse.org/paho/files/jsdoc/Paho.MQTT.Client.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("文档"),s("OutboundLink")],1)]),e._v(" "),s("li",[e._v("protobuf 实现字符串跟二进制之间的相互转换")])]),e._v(" "),s("p",[e._v("友情提示: IM最难的并不是websocket,而是交互")]),e._v(" "),e._m(2),e._v(" "),e._m(3),e._m(4),e._v(" "),s("ol",[s("li",[e._v("IM消息体格式参考链接 "),s("a",{attrs:{href:"http://confluence.rd.91160.com/pages/viewpage.action?pageId=12988649",target:"_blank",rel:"noopener noreferrer"}},[e._v("confluence"),s("OutboundLink")],1)]),e._v(" "),s("li",[e._v("实际应用")])]),e._v(" "),e._m(5),e._m(6),e._v(" "),e._m(7),e._v(" "),e._m(8),e._m(9),e._v(" "),e._m(10),e._m(11),e._v(" "),e._m(12),e._v(" "),e._m(13),e._m(14),e._v(" "),e._m(15),e._m(16),e._v(" "),e._m(17),e._v(" "),e._m(18),e._m(19),e._v(" "),e._m(20),s("p",[e._v("方法二(91160-com)推荐")]),e._v(" "),e._m(21),e._m(22),e._v(" "),e._m(23)])},[function(){var e=this.$createElement,t=this._self._c||e;return t("h1",{attrs:{id:"健康商城客服咨询"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#健康商城客服咨询","aria-hidden":"true"}},[this._v("#")]),this._v(" 健康商城客服咨询")])},function(){var e=this.$createElement,t=this._self._c||e;return t("h2",{attrs:{id:"技术栈"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#技术栈","aria-hidden":"true"}},[this._v("#")]),this._v(" 技术栈")])},function(){var e=this.$createElement,t=this._self._c||e;return t("h2",{attrs:{id:"websocket链接的创建"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#websocket链接的创建","aria-hidden":"true"}},[this._v("#")]),this._v(" websocket链接的创建")])},function(){var e=this.$createElement,t=this._self._c||e;return t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[this._v("initWebsocket(){\n    var that = this;\n    var options = { // websocket 连接的配置\n        useSSL:true, // 开启安全传输 wss\n        userName:this.user.user_id, // 用户名,通过接口获取\n        password:this.user.access_token, // 密码,通过接口获取\n        keepAliveInterval:10, // 发送心跳的时间,单位s, 不设置长时间不发消息websocket会自动断开\n        timeout: 10, // 发送消息超时的时间\n        onSuccess: function () { // websocket链接成功的回调\n        }\n        onFailure: function (message) { // websocket链接失败的回调\n            console.log(\"Connection failed: \" + message.errorMessage);\n        }\n    };\n    this.clientSocket = new PahoMQTT.Client('wss://msgwss.91160.com/mqtt', this.client_id);  // 通过域名连接\n    // this.clientSocket = new PahoMQTT.Client('10.1.95.159',8090, this.client_id); // 通过ip跟端口连接\n    this.clientSocket.connect(options);\n}\n")])])])},function(){var e=this.$createElement,t=this._self._c||e;return t("h2",{attrs:{id:"im消息体组装"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#im消息体组装","aria-hidden":"true"}},[this._v("#")]),this._v(" IM消息体组装")])},function(){var e=this.$createElement,t=this._self._c||e;return t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[this._v("var obj = {\n    content:JSON.stringify({\n        type: 1, // 1.普通消息2.图片, 其他值参考confluence\n        business_id:this.orderNo,\n        business_type:20,\n        receiver_type:1, //2代表医生,1代表患者,3//平台客服/4:商家客服\n        networkProvider:'webIm',\n        networkType:'-2'\n    }),\n    send_time: + new Date(),\n    sender_uid:this.user.user_id.toString(), // 发送者的user_id\n    receiver_uid:this.customer_id.toString(), // 接收者的user_id\n    member_id:0, // 家庭成员id,健康商城客服聊天固定是0,随访的时候选择对应的家庭成员\n    message_id:getUuid(), // uuid,随机不重复的字符串\n    guid:'',\n    session_id:this.session_id, // 由sender_uid和receiver_uid组成,值小的在前,大的在后, ${receiver_uid}_${sender_uid}\n    business_type:20 // 具体指参考confluence\n}\n")])])])},function(){var e=this.$createElement,t=this._self._c||e;return t("h2",{attrs:{id:"如何转换成二进制"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#如何转换成二进制","aria-hidden":"true"}},[this._v("#")]),this._v(" 如何转换成二进制")])},function(){var e=this.$createElement,t=this._self._c||e;return t("ol",[t("li",[this._v("方法一(运用于wechat-vue仓库)")])])},function(){var e=this.$createElement,t=this._self._c||e;return t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[this._v("# MessageFormat_pb.js 是由c++程序protoc将IM.proto(文件路径'./IM.proto')文件转换成的,\n# 具体命令 protoc --js_out=import_style=commonjs,binary:. IM.proto\nimport Message_pb from '../../../plugins/protobuf/MessageFormat_pb.js'\nthis.message = new Message_pb.Message();  \nserializeBinary(obj){//将内容序列化成protobuf格式\n    this.message.setContent(obj.content);\n    this.message.setSendTime(obj.send_time);\n    this.message.setReceiverUid(obj.receiver_uid);\n    this.message.setMemberId(obj.member_id);\n    this.message.setMessageId(obj.message_id);\n    this.message.setGuid(obj.guid);\n    this.message.setSenderUid(obj.sender_uid);\n    this.message.setSessionId(obj.session_id);\n    this.message.setBusinessType(obj.business_type);\n    return this.message.serializeBinary();\n}\nvar buffer = serializeBinary(obj)\n")])])])},function(){var e=this.$createElement,t=this._self._c||e;return t("ol",{attrs:{start:"2"}},[t("li",[this._v("方法二(运用于91160-com仓库)推荐")])])},function(){var e=this.$createElement,t=this._self._c||e;return t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[this._v('// protobuf 为外部应用的js库\nprotobuf.load("/im/js/IM.proto", function(err, root) {\n    if (err) {\n        reject(err)\n    }else {\n        that.Message = root.lookupType("IMpackage.Message");\n        resolve()\n    }\n});\nvar buffer = that.Message.encode(obj).finish();\n')])])])},function(){var e=this.$createElement,t=this._self._c||e;return t("h2",{attrs:{id:"im消息发送"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#im消息发送","aria-hidden":"true"}},[this._v("#")]),this._v(" IM消息发送")])},function(){var e=this.$createElement,t=this._self._c||e;return t("ol",[t("li",[this._v("发送")])])},function(){var e=this.$createElement,t=this._self._c||e;return t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[this._v("// client.send(topic,payload,qos);\nthis.clientSocket.send('PTP',buffer,2);\n// PTP 后端定制的主题\n// buffer obj转换成的buffer\n// qos: 0 Best effort (default). 1 At least once. 2 Exactly once.\n")])])])},function(){var e=this.$createElement,t=this._self._c||e;return t("ol",[t("li",[this._v("如何知道成功发送")])])},function(){var e=this.$createElement,t=this._self._c||e;return t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[this._v("// java收到消息之后会自动发送一个确认的消息,客户端的websocket会触发onMessageDelivered\nthis.clientSocket.onMessageDelivered = function(message){ // 消息送达的回调\n    console.log('message Delivered');\n    console.log(message) // message为自己最开始send的内容\n    var msg = that.message.toObject(message.payloadBytes) //  that.message.toObject方法会将二进制转换成对象\n    \n};\n")])])])},function(){var e=this.$createElement,t=this._self._c||e;return t("h2",{attrs:{id:"im消息接收"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#im消息接收","aria-hidden":"true"}},[this._v("#")]),this._v(" IM消息接收")])},function(){var e=this.$createElement,t=this._self._c||e;return t("ol",[t("li",[this._v("接受消息")])])},function(){var e=this.$createElement,t=this._self._c||e;return t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[this._v("// websocket监听onMessageArrived时间,当别的人发送消息给自己是会触发onMessageArrived\nthis.clientSocket.onMessageArrived = function (message) { // broker消息送达\n} \n")])])])},function(){var e=this.$createElement,t=this._self._c||e;return t("ol",{attrs:{start:"2"}},[t("li",[this._v("接受的消息是二进制,需要解码\n方法一 (wechat-vue)")])])},function(){var e=this.$createElement,t=this._self._c||e;return t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[this._v("var array = that.message.deserializeBinary(message.payloadBytes).array,\nobj = {};\nobj.content = JSON.parse( array[0] );\nobj.send_time = array[1];\nobj.receiver_uid = array[2];\nobj.sender_uid = array[3];\nobj.member_id = array[4];\nobj.message_id = array[5];\nobj.guid = array[6];\nobj.session_id = array[7];\nobj.business_type = array[8];\nobj.is_read = 0;\nconsole.log(obj)\n\n")])])])},function(){var e=this.$createElement,t=this._self._c||e;return t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[this._v('protobuf.load("/im/js/IM.proto", function(err, root) {\n    if (err) {\n        reject(err)\n    }else {\n        that.Message = root.lookupType("IMpackage.Message");\n        resolve()\n    }\n});\nvar message = that.Message.decode(message.payloadBytes);\n')])])])},function(){var e=this.$createElement,t=this._self._c||e;return t("h2",{attrs:{id:"websocket连接重新连接"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#websocket连接重新连接","aria-hidden":"true"}},[this._v("#")]),this._v(" websocket连接重新连接")])},function(){var e=this.$createElement,t=this._self._c||e;return t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[this._v("// websocket 连接断开,会触发onConnectionLost回调\n this.clientSocket.onConnectionLost = function (responseObject) {//websocket断开重新连接\n    var options = { // 配置参考上面连接的时候\n    };\n    that.clientSocket.connect(options);\n};\n")])])])}],!1,null,null,null);a.options.__file="readme.md";t.default=a.exports}}]);