<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>微信端前后端分离项目 | 健康160前端分享</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/frontend/dist/assets/css/styles.38cf4c8a.css" as="style"><link rel="preload" href="/frontend/dist/assets/js/app.38cf4c8a.js" as="script"><link rel="preload" href="/frontend/dist/assets/js/11.6b812224.js" as="script"><link rel="prefetch" href="/frontend/dist/assets/css/2.styles.083de942.css"><link rel="prefetch" href="/frontend/dist/assets/css/4.styles.5ce1cb36.css"><link rel="prefetch" href="/frontend/dist/assets/js/1.5650c4c0.js"><link rel="prefetch" href="/frontend/dist/assets/js/10.1f8f8057.js"><link rel="prefetch" href="/frontend/dist/assets/js/2.083de942.js"><link rel="prefetch" href="/frontend/dist/assets/js/3.ca56cc0b.js"><link rel="prefetch" href="/frontend/dist/assets/js/4.5ce1cb36.js"><link rel="prefetch" href="/frontend/dist/assets/js/5.c070d30d.js"><link rel="prefetch" href="/frontend/dist/assets/js/6.212aefff.js"><link rel="prefetch" href="/frontend/dist/assets/js/7.d33824cd.js"><link rel="prefetch" href="/frontend/dist/assets/js/8.264e1fee.js"><link rel="prefetch" href="/frontend/dist/assets/js/9.2c0395b9.js">
    <link rel="stylesheet" href="/frontend/dist/assets/css/2.styles.083de942.css"><link rel="stylesheet" href="/frontend/dist/assets/css/4.styles.5ce1cb36.css"><link rel="stylesheet" href="/frontend/dist/assets/css/styles.38cf4c8a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/frontend/dist/" class="home-link router-link-active"><!----> <span class="site-name">健康160前端分享</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/frontend/dist/" class="nav-link">Home</a></div><div class="nav-item"><a href="/frontend/dist/guide/" class="nav-link">Guide</a></div><div class="nav-item"><a href="https://google.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  External
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/frontend/dist/" class="nav-link">Home</a></div><div class="nav-item"><a href="/frontend/dist/guide/" class="nav-link">Guide</a></div><div class="nav-item"><a href="https://google.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  External
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first collapsable"><p class="sidebar-heading"><span>移动端远程调试</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>原生JS</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>面向对象</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>智能页面</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>IM即时通讯</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading open"><span>wechat-vue</span> <span class="arrow down"></span></p> <ul class="sidebar-group-items"><li><a href="/frontend/dist/wechat-vue/" class="active sidebar-link">微信端前后端分离项目</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/frontend/dist/wechat-vue/#目录结构介绍" class="sidebar-link">目录结构介绍</a></li></ul></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="微信端前后端分离项目"><a href="#微信端前后端分离项目" aria-hidden="true" class="header-anchor">#</a> 微信端前后端分离项目</h1> <h2 id="目录结构介绍"><a href="#目录结构介绍" aria-hidden="true" class="header-anchor">#</a> 目录结构介绍</h2> <h3 id="配置文件"><a href="#配置文件" aria-hidden="true" class="header-anchor">#</a> 配置文件</h3> <div class="language- extra-class"><pre class="language-text"><code>路径: \www\api\wechat-vue\config\index.js
build: {
    env: { // 设置环境变量,区分是dev,test还是build
        NODE_ENV: '&quot;production&quot;'
    },
    index: path.resolve(__dirname, '../dist/index.html'), // 打包之后index.html的存放路径
    assetsRoot: path.resolve(__dirname, '../dist'), // 打包之后静态资源存放路径
    assetsSubDirectory: '', 
    assetsPublicPath: '//wximg.91160.com/dist/', // 打包之后index.html中资源引用的prefix
    productionSourceMap: true,
    productionGzip: false,
    productionGzipExtensions: ['js', 'css'],
    appid: 'wx0001f8ab87472985' // 线上微信公众号的AppID
},
</code></pre></div><h3 id="plugins目录介绍"><a href="#plugins目录介绍" aria-hidden="true" class="header-anchor">#</a> plugins目录介绍</h3> <div class="language- extra-class"><pre class="language-text"><code>\www\api\wechat-vue\src\plugins.
│  autosize.min.js  // textarea高度自适应, 需要单独引用
│  axios.js  // 基于创建了axios的实例
│  BMap.js  // 动态加载百度地图
│  components.js // 全局注册的组件,现在只有vux的ToastPlugin
│  data.js 
│  loading.js // 全局注册的loading组件,最开始的用途是ajax请求前loading,请求介绍后结束loading,参考app.vue中的逻辑,需要在对应的路由里面配置参数
│  mqttws31.js // 创建websocket的第三方库
│  navigateBar.js // 全局注册的navigatebar
│  prototype.js // 所有绑定到vue原型上面的方法
│  setToken.js // 开发模式下设置盗取token自动登录
│  swiper.min.js
│  vueRouter.js // 路由拦截
├─fastclick
│      fastclick.js
│      index.js  // 解决click事件移动端300ms延迟
├─preview  
│      index.js  //基于vux preview修改过的文件,解决多组图放大时动画问题
│      preview.vue
├─protobuf 
│      MessageFormat_pb.js  //利用protoc将IM.proto转换的commonjs文件
├─swiper
│
└─weui
</code></pre></div><ol><li>axios.js介绍
功能: 请求拦截,响应拦截,设置通用请求头,给vue原型添加$http方法
<ul><li>请求拦截,url上面有vapp,cid,qqHealthOpenId,city_id,的参数,ajax请求会自动带上,以及在appwebview里面,会先获取app的jstoken,如果app是登录状态,会自动再ajax请求上面添加jstoken,后面接受到jstoken会同步app那边的登录态</li></ul> <div class="language- extra-class"><pre class="language-text"><code>const instance = axios.create();
instance.interceptors.request.use(function(config) { //配置发送请求的信息
    var vapp = getUrlParam('vapp') // app的版本好
    var cid = getUrlParam('cid') // 渠道id
    var city_id = getUrlParam('city_id') // 城市id
    var qqHealthOpenId = getUrlParam('qqHealthOpenId') // qqHealthOpenId
    if(qqHealthOpenId){//所有请求添加qqHealthOpenId腾讯获取订单状态回传
        addParamsToUrl(config,'qqHealthOpenId',qqHealthOpenId)
    }
    if(vapp) { // 所有请求添加app版本号
        addParamsToUrl(config,'vapp',vapp)
    }
    if(city_id) { // 所有请求添加城市id
        addParamsToUrl(config,'city_id',city_id)
    }
    if(cid) { //渠道号
        if(config.url.indexOf('cid') == -1) {
            addParamsToUrl(config,'cid',cid)
        }
    }
    if(typeof(mJavaScriptObject) === 'object' &amp;&amp; !config.url.includes('jstoken')) {
        addParamsToUrl(config, 'jstoken', encodeURIComponent(getAppToken(cid)));
    }
    return config;
}, function(error) {
    return Promise.reject(error);
});
</code></pre></div><ul><li>响应拦截, 未登录情况下,调用需要登录的接口,服务器返回状态码-1,会自动跳转到登录页面,登录成功之后会自动返回,如果请求的url上带有specialJump不等于空的情况下,即使未登录的情况访问需要需要登录的接口,页面也不会自动跳转</li></ul> <div class="language- extra-class"><pre class="language-text"><code>instance.interceptors.response.use(function(response) { //配置请求回来的信息
    if(response.config.params &amp;&amp; response.config.params.specialJump) {
        return response;
    }
    if (response.data.login == -1) { //未登录
        window.location.href=&quot;/user/login.html?redirect_url=&quot;+encodeURIComponent(location.href);
        return;
    }
    return response;
}, function(error) {
    return Promise.reject(error);
});
</code></pre></div><ul><li>X-Requested-With Request Header,配合后端添加的请求头,方便后台判断是通过ajax访问还是直接浏览器地址栏输入url访问</li></ul> <div class="language- extra-class"><pre class="language-text"><code>instance.defaults.headers.common['X-Requested-With'] = 'XMLHttpRequest';
</code></pre></div></li> <li>vueRouter.js介绍
功能: 路由创建,路由拦截,自动登录,设置app分享按钮
<ul><li>404页面,保证404页面的路由*在最底部,防止其他路由访问不了</li></ul> <div class="language- extra-class"><pre class="language-text"><code>routes[0].children = routes[0].children.concat(common); 
</code></pre></div><ul><li>路由设置</li></ul> <div class="language- extra-class"><pre class="language-text"><code>const router = new VueRouter({
    routes,
    mode: routerMode,
    scrollBehavior(to, from, savedPosition) {
    // 因为本地是 hash 模式，线上是 history 模式，hash 模式无法使用 savedPosition，使用全局设置来处理
    // 相同的页面并且在全局设置里定义的页面不跳回顶部
    if (to.path == from.path &amp;&amp; GlobalSetting.keepPositionPaths.includes(to.path)) return
    if (savedPosition) {
        return savedPosition;
    } else if(to.query.toTop &amp;&amp; to.query.toTop === 'true') { //如果路径带有此参数，我们不做任何滚动，参考/gjyl/goodsList/servePageScroll.html?toTop=true页面
        return
    } else {
        return { x: 0, y: 0 };
    }
    },
    strict: process.env.NODE_ENV !== 'production'
})
</code></pre></div><ul><li>beforeEach钩子</li></ul> <div class="language- extra-class"><pre class="language-text"><code>if (to.matched.some(record =&gt; record.meta.title)) { // 如果路由配置的时候配置了meta: {title: 'xxx'}, 会自动设置页面的title
  document.title = to.meta.title;
}
一. 通过momentKey自动登录,如果连接上面的有momentKey参数,会自动拦截调用通过momentKey自动登录的接口
二. 路由配置的时候配置了meta: { needLogin: true }
    1. 先判断是否登录
    是: next() 继续访问
    否: 判断是app里面
        是: 获取app的jstoken,调用loginByAppToken接口知道登录,登录成功next(),否则跳转登录页面
        否: 
            判断是否在微信里面
            是:
                连接上面是否有code
                否: 跳转到 https://open.weixin.qq.com/connect/oauth2/authorize?appid=&quot; + appId + &quot;&amp;redirect_uri=&quot; + encodeURIComponent(origin + to.fullPath) + &quot;&amp;response_type=code&amp;scope=snsapi_base&amp;state=91160#wechat_redirect&quot;`获取code之后自动跳回
                是: 通过code调用loginByCode自动登录,登录成功next(),否则跳转登录页面
            否: 跳转登录页面

</code></pre></div><ul><li>afterEach钩子,判断是否在app里面,控制是否分享按钮</li></ul> <div class="language- extra-class"><pre class="language-text"><code> if( typeof(mJavaScriptObject) == 'object' &amp;&amp; (mJavaScriptObject.funGetVersion() &gt; '6.0.8')) {
    if(to.meta.canShare) {
        mJavaScriptObject.funShowShareButton('1')
    }else {
        mJavaScriptObject.funShowShareButton('0')
    }
}
</code></pre></div></li></ol></div> <div class="page-edit"><!----> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/frontend/dist/IM/" class="prev">
          健康商城客服咨询
        </a></span> <!----></p></div> </div> <!----></div></div>
    <script src="/frontend/dist/assets/js/11.6b812224.js" defer></script><script src="/frontend/dist/assets/js/app.38cf4c8a.js" defer></script>
  </body>
</html>
